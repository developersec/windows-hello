<link rel="import" href="bower_components/polymer/polymer.html">

<script src="scripts/mswebauthn.js"></script>

<!--
`windows-hello`
&lt;windows-hello&gt; is a custom element used to authenticate with  Windows Hello

@demo demo/index.html 
-->

<dom-module id="windows-hello">
  <template>
    <style>
      :host {
        display: block;
      }

      :host input[type=button].default {
        color: rgb(255, 255, 255);
        background-color: rgb(38, 114, 236);
      }

      :host button.default {
        color: rgb(255, 255, 255);
        background-color: rgb(38, 114, 236);
      }

      :host button {
        padding: 3px 12px 5px;
        border: 0px currentColor;
        border-image: none;
        height: 2.14em;
        color: rgb(33, 33, 33);
        font-family: "Segoe UI Semibold", "Segoe UI Web Semibold", "Segoe UI Web Regular", "Segoe UI", "Segoe UI Symbol", "HelveticaNeue-Medium", "Helvetica Neue", Arial, sans-serif;
        font-size: 100%;
        min-width: 6em;
        background-color: rgba(182, 182, 182, 0.7);
      }

      div.section {
        margin-bottom: 30px;
      }

      div.section.header {
        margin-bottom: 20px;
      }

      div.section.buttons {
        margin-top: 40px;
      }

      div.section.inline {
        display: inline-block;
      }

      div.section.last {
        margin-bottom: 0px;
      }
    </style>

    <div class="section">
      <button class="default" id="buttonlogonwithpassword" on-click="makeCredential">Start using Windows Hello!</button>
      <button class="default" id="buttonlogonwithwindowshello" on-click="getAssertion">Sign In with Windows Hello</button>
    </div>

  </template>

  <script>

    class WindowsHello extends Polymer.Element {

      static get is() { return 'windows-hello'; }

      static get properties() {
        return {
          relyingParty: {
            type: String,
            reflectToAttribute: true,
            value: "Contoso"
          },
          displayName: {
            type: String,
            reflectToAttribute: true,
            value: "John Doe"
          },
          accountName: {
            type: String,
            reflectToAttribute: true,
            value: "johndoe@contoso.com"
          },
          accountId: {
            type: String,
            reflectToAttribute: true,
            value: "joed"
          },
          challenge: {
            type: String,
            value: 'Our fathers brought forth on this continent, a new nation'
          }        
        }
      }

      ready() {
        super.ready();
        // If Windows Hello registered, show this option first
        if (window.sessionStorage && window.sessionStorage.getItem("credentialID")) {
          this.$.buttonlogonwithpassword.hidden = true;
          this.$.buttonlogonwithwindowshello.hidden = false;
        } 
        // If Windows Hello not registered, show password options
        else {
          this.$.buttonlogonwithpassword.hidden = false;
          this.$.buttonlogonwithwindowshello.hidden = true;
        }      
      }      

      // Register user with FIDO 2.0
      makeCredential() {
        try {
          // This information would normally come from the server
          var accountInfo = {
            rpDisplayName: this.relyingParty,           // Name of relying party
            displayName: this.displayName,            // Name of user account in relying partying
            name: this.accountName,        // Detailed name of account
            id: this.accountId  			            // Account identifier
          };

          var cryptoParameters = [
            {
              type: 'FIDO',
              algorithm: 'RSASSA-PKCS1-v1_5'
            }
          ];

          // We won't use this optional parameters
          var timeout = {};
          var denyList = {};
          var ext = {};

          // The challenge is typically a random quantity generated by the server
          // This ensures that any assertions are freshly generated and not replays

          webauthn.makeCredential(accountInfo, cryptoParameters, this.challenge, timeout, denyList, ext)
            .then(function (creds) {
              // If promise returns successfully, store credID locally
              if (window.sessionStorage) {
                window.sessionStorage.setItem('credentialID', creds.credential.id);
                window.sessionStorage.setItem('algorithm', creds.algorithm);
                window.sessionStorage.setItem('publicKey', creds.publicKey.n);
              }

              // Share credential information with server
              sendToServer(creds);

              this.fire('windows-hello-signin-success');
            })
            .catch(function (reason) {
              // Windows Hello isn't setup, show dialog explaining how to set it up
              if (reason.message === 'NotSupportedError') {
                this.fire("windows-hello-signin-error", { description: "You need to setup Windows Hello. Select the Start button, then select Settings > Accounts > Sign-in options to set up Windows Hello. Under Windows Hello, you’ll see options for face, fingerprint, or iris if your PC has a fingerprint reader or  camera that supports it. Once you’re set up, you’ll be able to sign in with a quick swipe or glance." })
              }
              //console.log('Windows Hello failed (' + reason.message + ').');
            });
        } catch (ex) {
          //console.log('makeCredential() failed: ' + ex);  
          this.fire("windows-hello-signin-error", { description: ex });
        }
      }

      // Authenticate the user
      getAssertion() {
        try {
          // The challenge is typically a random quantity generated by the server 
          // This ensures that any assertions are freshly generated and not replays
          //var challenge = 'Our fathers brought forth on this continent, a new nation';
          var allowList =
            [
              {
                type: 'FIDO',
                id: window.sessionStorage.getItem('credentialID')
              }
            ];

          var timeout = {};
          var ext = {};

          webauthn.getAssertion(this.challenge, timeout, allowList, ext)
            .then(function (sig) {
              // Assertion calls succeeds
              // Send assertion to the server
              sendToServer(sig);

              this.fire('windows-hello-signin-success');
            })
            .catch(function (reason) {
              // No credential in the store. Fallback to password
              // Show dialog with failed authentication. Fallback to password. 
              //console.log('getAssertion() failed: ' + reason);
              this.fire("windows-hello-signin-error", { description: reason });
            });
        } catch (ex) {
          //console.log('getAssertion() failed: ' + ex);
          this.fire("windows-hello-signin-error", { description: ex });
        }
      }

      sendToServer(msg) {
        // This is where you would send data to the server   
        return null;
      }

    }

    // Register the windows-hello element with the browser
    customElements.define(WindowsHello.is, WindowsHello);

  </script>
</dom-module>